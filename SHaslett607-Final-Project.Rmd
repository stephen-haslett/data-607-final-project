---
title: "Property Prices and Crime in NYC"
author: "Stephen Haslett"
date: "12/10/2019"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
    toc: yes
subtitle: "DATA 607 Final Data Project"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
library(RCurl)
library(XML)
library(jsonlite)
library(knitr)
library(kableExtra)
library(tidyverse)
library(tidyr)
library(geosphere)
library(leaflet)
library(plyr)
library(tools)
library(prettydoc)
library(ggrepel)
```


##Objective

For this project, I will investigate the correlation between crime and property prices within NYC's 5 boroughs. The 3 main questions I want to answer are:

1. What is the correlation between crime and property prices in NYC?

2. Do specific types of crime have an affect on property values?

3. As the number of arrests decrease in a borough, do property values increase?

##Data Sources

The 2 main data sources I will use for this project can be found on NYCOpenData (https://opendata.cityofnewyork.us/data/).

I will explore the "NYPD Arrests Data (Historic)" dataset, and will compare this to the "Revised Notice of Property Value (RNOPV)" dataset which contains NYC Department of Finance property evaluation data. Both datasets contain a borough column, so this will be my starting point for correlating the 2 sets of data, and will allow me to start identifying patterns between crime and property prices.

The NYPD Arrests dataset contains information on the types of offenses that were committed prior to the arrest, and so this can be utilized to investigate what affect specific crimes have (if any) on property values. 

#### Fetch the Necessary Data.

The _NYPD Arrests Data (Historic)_ csv file is 2.05 GB, so I decided to obtain the data via NYCOpenData's JSON endpoint to save on memory.

```{r, message=FALSE, warning=FALSE}
crime_data <- fromJSON("https://data.cityofnewyork.us/resource/qgea-i56i.json")
nyc_population <- fromJSON("https://data.cityofnewyork.us/resource/xywu-7bv9.json")
```

### Cleaning the Data.

#### View the number of columns and rows in the dataset.
```{r, message=FALSE, warning=FALSE}
dim(crime_data)
```

#### Now look at the data structure, and column names.
```{r, message=FALSE, warning=FALSE}
str(crime_data)
```


#### Column names.
```{r, message=FALSE, warning=FALSE}
colnames(crime_data)
```


**We don't need all of the information in the dataset for our analysis, so we take what we need, and leave what we don't.**

```{r, message=FALSE, warning=FALSE}
# Extract the columns with the data that we need.
crime_data_refined <- select(crime_data, rpt_dt, ofns_desc, ofns_desc, law_cat_cd, boro_nm, addr_pct_cd, latitude, longitude, lat_lon)

# Remove NAs from the data.
sapply(crime_data_refined, function(x) sum(is.na(x)))
clean_crime_data <- na.omit(crime_data_refined)
sapply(clean_crime_data, function(x) sum(is.na(x)))

summary(clean_crime_data)
```

#### Look at a sample of the clean data.
```{r, message=FALSE, warning=FALSE}
sample_n(clean_crime_data, 5)
```

### Clean The NYC Population Data

```{r, message=FALSE, warning=FALSE}
# We only need 2 columns from the table (Borough and Population).
nyc_population_refined <- select(nyc_population, borough, '_2020')

# Remove NAs from the data.
sapply(nyc_population_refined, function(x) sum(is.na(x)))
clean_pop_data <- na.omit(nyc_population_refined)
sapply(clean_pop_data, function(x) sum(is.na(x)))

# Get rid of the NYC Total population row as we don't need it.
clean_pop_data = clean_pop_data[-1,]

# Rename the columns.
colnames(clean_pop_data) <- c('Borough', 'Population')

sample_n(clean_pop_data, 5)
```

### Data Analysis


#### Crime Frequency by Borough.
```{r, message=FALSE, warning=FALSE}
# Count the occurences of a borough name to give us an idea of the crime rate in the borough.
crimes_per_borough <- table(clean_crime_data$boro_nm)
head(crimes_per_borough)
```


#### Create a new dataframe that contains a population column for each borough.
```{r, message=FALSE, warning=FALSE}
crimes_dataframe <- as.data.frame(crimes_per_borough, stringsAsFactors=FALSE)
population_dataframe <- as.data.frame(clean_pop_data, stringsAsFactors=FALSE)

# Add column names to the crimes_dataframe.
colnames(crimes_dataframe) <- c('Borough', 'Crimes')

# Convert borough names to title case form so that we can join on 'Borough'
# with the population_dataframe.
crimes_dataframe$Borough <- str_to_title(crimes_dataframe$Borough)
crimes_population <- join(crimes_dataframe, population_dataframe, by = 'Borough', type = 'right')
crimes_population$Crimes <- crimes_dataframe$Crimes

crimes_population
```


#### Calculate the crime rate for each Borough and add a CrimeRate column to the crimes_population dataframe.

```{r, message=FALSE, warning=FALSE}
crime_rate <- as.numeric(crimes_population$Crimes) / as.numeric(crimes_population$Population) * 100000
crimes_population$CrimeRate <- round(as.numeric(format(crime_rate, scientific = FALSE)), 2)
crimes_population
```


#### Plot a bar graph displaying the crime rates for each borough.

```{r, message=FALSE, warning=FALSE}
crime_by_borough_plot <-ggplot(crimes_population, aes(x = Borough, y = CrimeRate, fill = Borough)) +
  geom_bar(stat = 'identity') +
      labs(title = 'Crime Rates by Borough',
         x = 'Borough',
         y = 'Crime Rate')


crime_by_borough_plot
```



### New York City crime by category
```{r, message=FALSE, warning=FALSE}
cat_by_boro <- select(clean_crime_data, law_cat_cd)

crime_category_table <- table(cat_by_boro$law_cat_cd)
crime_category_table <- sort(crime_category_table, decreasing = TRUE)

crime_by_category <- as.data.frame(crime_category_table, stringsAsFactors = FALSE)
colnames(crime_by_category) <- c("Category", "Frequency")
crime_by_category$Percentage <- crime_by_category$Frequency / sum(crime_by_category$Frequency) * 100
crime_by_category
```


### Plot a bar graph displaying displaying NYC crime by category.
```{r, message=FALSE, warning=FALSE}
crime_by_category_plot <-ggplot(crime_by_category, aes(x = Category, y = Frequency, fill = Category)) + 
  geom_bar(stat="identity") + 
        labs(title = 'Crime by Category',
         x = 'Category',
         y = 'Frequency')
  
crime_by_category_plot
```


