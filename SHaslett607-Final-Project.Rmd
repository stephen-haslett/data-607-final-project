---
title: "NYC Crime Rates"
author: "Stephen Haslett"
date: "12/10/2019"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
    toc: yes
subtitle: "DATA 607 Final Data Project"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
library(RCurl)
library(XML)
library(jsonlite)
library(knitr)
library(kableExtra)
library(tidyverse)
library(tidyr)
library(geosphere)
library(leaflet)
library(plyr)
library(tools)
library(prettydoc)
library(ggrepel)
```


##Objective

For this project, I will investigate crime, and crime rates in NYC. The main questions I want to answer are:

1. Which NYC borough has the highest crime rate?

2. Which category of crimes are most common in New York City as a whole?


### Data Sources

The 2 main data sources I will use for this project can be found on NYCOpenData (https://opendata.cityofnewyork.us/data/).

I will explore the "NYPD Arrests Data (Historic)" dataset, and will pull crime statistics from this set in order to explore crime rates in NYC. I will also use the "New York City Population by Borough, 1950 - 2040" dataset in order to calculate crime rates per New York City borough.

The datasets can be found at the following locations:

NYPD Arrests Data (Historic) - https://data.cityofnewyork.us/Public-Safety/NYPD-Arrests-Data-Historic-/8h9b-rp9u

New York City Population by Borough, 1950 - 2040 - https://data.cityofnewyork.us/City-Government/New-York-City-Population-by-Borough-1950-2040/xywu-7bv9


#### Import the Datasets.

The _NYPD Arrests Data (Historic)_ csv file is 2.05 GB, so I decided to obtain the data via NYCOpenData's JSON endpoint to save on memory. The _New York City Population by Borough, 1950 - 2040_ csv file is only 4 KB, but for consistency, I also imported this dataset via the JSON endpoint.

```{r, message=FALSE, warning=FALSE}
crime_data <- fromJSON("https://data.cityofnewyork.us/resource/qgea-i56i.json")
nyc_population <- fromJSON("https://data.cityofnewyork.us/resource/xywu-7bv9.json")
```

#### Data Cleansing


### NYPD Arrests Dataset

#### View the number of columns and rows in the crime_data dataset.
```{r, message=FALSE, warning=FALSE}
dim(crime_data)
```

#### Now look at the data structure, and column names.
```{r, message=FALSE, warning=FALSE}
str(crime_data)
```


#### List the dataset column names so we can see which columns are useful for analysis purposes.
```{r, message=FALSE, warning=FALSE}
colnames(crime_data)
```


**We don't need all of the information in the crime_data dataset for our analysis, so we take what we need, and leave what we don't.**

#### Clean the crime_data dataset so that we can use it for our analysis.
```{r, message=FALSE, warning=FALSE}
# Extract the columns containing the data that we need.
crime_data_refined <- select(crime_data, rpt_dt, ofns_desc, pd_desc, ofns_desc, law_cat_cd, boro_nm, addr_pct_cd, latitude, longitude, lat_lon)

# Remove NAs from the data.
sapply(crime_data_refined, function(x) sum(is.na(x)))
clean_crime_data <- na.omit(crime_data_refined)
sapply(clean_crime_data, function(x) sum(is.na(x)))

summary(clean_crime_data)
```

#### Look at a sample of the clean data.
```{r, message=FALSE, warning=FALSE}
sample_n(clean_crime_data, 5)
```

### NYC Population Dataset

#### View the number of columns and rows in the nyc_population dataset.
```{r, message=FALSE, warning=FALSE}
dim(nyc_population)
```


#### Look at the data structure, and column names.
```{r, message=FALSE, warning=FALSE}
str(nyc_population)
```


#### List the dataset column names.

```{r, message=FALSE, warning=FALSE}
colnames(nyc_population)
```


#### Clean the nyc_population dataset.

```{r, message=FALSE, warning=FALSE}
# We only need 2 columns from the table (Borough and Population).
nyc_population_refined <- select(nyc_population, borough, '_2020')

# Remove NAs from the data.
sapply(nyc_population_refined, function(x) sum(is.na(x)))
clean_pop_data <- na.omit(nyc_population_refined)
sapply(clean_pop_data, function(x) sum(is.na(x)))

# Get rid of the NYC Total population row as we don't need it.
clean_pop_data = clean_pop_data[-1,]

# Rename the columns.
colnames(clean_pop_data) <- c('Borough', 'Population')

sample_n(clean_pop_data, 5)
```

### Data Analysis

#### Crime Frequency by Borough
```{r, message=FALSE, warning=FALSE}
# Count the occurences of a borough name to give us an idea of the crime rate in the borough.
crimes_per_borough <- table(clean_crime_data$boro_nm)
head(crimes_per_borough)
```


#### Create a new dataframe that contains a population column for each borough.
```{r, message=FALSE, warning=FALSE}
crimes_dataframe <- as.data.frame(crimes_per_borough, stringsAsFactors=FALSE)
population_dataframe <- as.data.frame(clean_pop_data, stringsAsFactors=FALSE)

# Add column names to the crimes_dataframe.
colnames(crimes_dataframe) <- c('Borough', 'Crimes')

# Convert borough names to title case form so that we can join on 'Borough'
# with the population_dataframe.
crimes_dataframe$Borough <- str_to_title(crimes_dataframe$Borough)

# Join the 2 tables together.
crimes_population <- join(crimes_dataframe, population_dataframe, by = 'Borough', type = 'right')
crimes_population$Crimes <- crimes_dataframe$Crimes

kable(crimes_population, "html", escape = F) %>%
  kable_styling("striped", full_width = T) %>%
  column_spec(1, bold = T)
```



#### Calculate the crime rate for each Borough, and add a CrimeRate column to the crimes_population dataframe.

```{r, message=FALSE, warning=FALSE}
crime_rate <- as.numeric(crimes_population$Crimes) / as.numeric(crimes_population$Population) * 100000
crimes_population$CrimeRate <- round(as.numeric(format(crime_rate, scientific = FALSE)), 2)
kable(crimes_population, "html", escape = F) %>%
  kable_styling("striped", full_width = T) %>%
  column_spec(1, bold = T)
```



#### Plot a bar graph displaying the crime rates for each borough.

```{r, message=FALSE, warning=FALSE}
crime_by_borough_plot <-ggplot(crimes_population, aes(x = Borough, y = CrimeRate, fill = Borough)) +
  geom_bar(stat = 'identity') +
      labs(title = 'Crime Rates by Borough',
         x = 'Borough',
         y = 'Crime Rate')


crime_by_borough_plot
```



### New York City crime by category
```{r, message=FALSE, warning=FALSE}
cat_nyc <- select(clean_crime_data, law_cat_cd)

crime_category_table <- table(cat_nyc$law_cat_cd)
crime_category_table <- sort(crime_category_table, decreasing = TRUE)

crime_by_category <- as.data.frame(crime_category_table, stringsAsFactors = FALSE)
colnames(crime_by_category) <- c("Category", "Frequency")
crime_by_category$Percentage <- crime_by_category$Frequency / sum(crime_by_category$Frequency) * 100
crime_by_category
```


### Bar graph displaying arrest frequency by crime category in NYC.
```{r, message=FALSE, warning=FALSE}
crime_by_category_plot <-ggplot(crime_by_category, aes(x = Category, y = Frequency, fill = Category)) + 
  geom_bar(stat="identity") + 
        labs(title = 'Crime by Category',
         x = 'Category',
         y = 'Frequency')
  
crime_by_category_plot
```


### Pie chart displaying arrest frequency by crime category in NYC.
```{r, message=FALSE, warning=FALSE}
crime_category_pie_chart <-ggplot(crime_by_category, aes(x = '', y = Frequency, fill = Category)) + 
  geom_bar(stat ='identity') +
  coord_polar(theta = 'y') +
  scale_x_discrete('') +
  labs(title = 'Crime by Category',
    x = 'Category',
    y = 'Frequency')

crime_category_pie_chart
```


Over half of all arrests in NYC are for misdemeanor offences (crimes such as petty theft, disorderly conduct, public intoxication, assault, etc.). Just under half as many felony arrests were made (crimes such as murder, burglary, arson, etc.), and the remainder of arrests were for violations (disorderly conduct, loitering, etc.). The low level of violation arrests is not surprising as these are low level crimes which rarely result in arrest.

These statistics make sense as felonies are less likely crimes, misdemeanors are less serious crimes, but often result in arrest, and violations rarely lead to arrest.

### Crimes Leading to The Least Arrests in NYC

```{r, message=FALSE, warning=FALSE}
least_crimes <- sort(table(clean_crime_data$pd_desc), decreasing = TRUE)
least_crimes <- data.frame(least_crimes[least_crimes < 10])
colnames(least_crimes) <- c('Crime', 'Frequency')
least_crimes$Percentage <- least_crimes$Frequency / sum(least_crimes$Frequency) * 100

kable(least_crimes, "html", escape = F) %>%
  kable_styling("striped", full_width = T) %>%
  column_spec(1, bold = T)
```

Finally, I wanted to look at the crimes that lead to the least amount of arrrests in NYC. It is interesting that these are all low level crimes. This would suggest that they are crimes that people rarely get arrested for, or that they are so low level that people rarely report these crimes.

##
